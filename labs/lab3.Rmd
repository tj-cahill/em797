---
title: 'Lab 3: Measuring Networks - Community Structure and Assortment'
author: "Tiernan Cahill"
date: "21/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Data and Required Packages
We will again be importing the graph objects to be used in this analysis from the serialized RDS format.

We will also need to load a few packages for this lab:

  - `dplyr` for wrangling data
  - `igraph` for modelling and visualizing our network
  - `igraphdata` for sample network data
  - `assortnet` for calculating assortment
  
(*Note*: Community detection algorithms can be quite slow for larger networks, so for the purposes of quickly demonstrating multiple approaches, we will use a smaller network provided in the `igraphdata` package, which models friendships among faculty members at a university (Nepusz et al., 2008).)

```{r load, message = FALSE}
library(dplyr)
library(igraph)
library(assortnet)

mention_graph <- readRDS("../data/mention_graph.RDS")
htag_graph <- readRDS("../data/htag_graph.RDS")
htag_uses_graph <- readRDS("../data/htag_uses_graph.RDS")

# Add faculty sample data to R environment
data("UKfaculty", package = "igraphdata")
```

# Community Detection


```{r comm-detect, warning=FALSE}
# Newman and Girvan's (2004) modularity optimization algorithmm based on edge
# betweenness
cluster_edge_betweenness(UKfaculty, directed = T) -> comms.betweenness

# Pons and Latapy's (2005) modularity optimization algorithm based on random 
# walk distances
cluster_walktrap(UKfaculty) -> comms.randomwalk

# Clauset et al.'s (2004) hierarchical agglomerative method designed to improve
# performance on large, sparesly populated graphs (only works for undirected
# networks)
cluster_fast_greedy(as.undirected(UKfaculty)) -> comms.fastgreedy

# Blondel et al.'s (2008) multi-level modularity optimization algorithm (also 
# only works for undirected networks)
cluster_louvain(as.undirected(UKfaculty)) -> comms.louvain
```

```{r comm-detect-output}
# Let's take a look at the output from one of the community detection algorithms
print(comms.louvain)

# How many communities are there?
length(comms.louvain)

# Compare this to the output from a different algorithm
length(comms.betweenness)

# How big is each community?
sizes(comms.louvain)

# Which community does each node belong to?
cbind(node = V(UKfaculty), 
      community = membership(comms.betweenness)) %>% 
  head(10)

# Try using the output of a different algorithm
cbind(node = V(UKfaculty), 
      community = membership(comms.randomwalk)) %>% 
  head(10)

# Which nodes are in each community?
communities(comms.randomwalk)

# What about a specific community
communities(comms.randomwalk)[[2]]
```
## Visualizing Community Detection

```{r comm-detect-viz, fig.width = 10}
# Set an RNG seed so that we get consistent layouts
set.seed(9)
l = layout_with_fr(UKfaculty)

# Plot the whole network, colour-coded by the faculty members' departments
plot(UKfaculty,
     layout = l,
     edge.arrow.mode = 0,
     vertex.label = NA,
     vertex.size = 6,
     vertex.color = V(UKfaculty)$Group,
     main = "Faculty at a UK University Grouped by Department")

# Add the results of some community detection algorithms to the visualization
par(mfrow=c(1, 3))

plot(comms.betweenness, UKfaculty,
     layout = l,
     edge.arrow.mode = 0,
     vertex.label = NA,
     vertex.size = 6,
     main = "Edge Betweenness")

plot(comms.randomwalk, UKfaculty,
     layout = l,
     edge.arrow.mode = 0,
     vertex.label = NA,
     vertex.size = 6,
     main = "Random Walks")

plot(comms.louvain, UKfaculty,
     layout = l,
     edge.arrow.mode = 0,
     vertex.label = NA,
     vertex.size = 6,
     main = "Louvain Method")
```

```{r comm-detect-viz2, fig.width = 10, fig.height = 12}
par(mfrow = c(2, 1))

# Convert the communities output to dendrgoram and plot
as.dendrogram(comms.fastgreedy) %>% 
  plot(leaflab = "none", horiz = T,
       main = "Fast Greedy Method")

as.dendrogram(comms.randomwalk) %>% 
  plot(leaflab = "none", horiz = T,
       main = "Random Walks")
```
# Measures of Community
## Modularity
## Assortment