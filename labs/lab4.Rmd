---
title: 'Intro to Network Regression'
author: "Tiernan Cahill"
date: "23/06/2021"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Data and Required Packages
We will again be importing the graph objects to be used in this analysis from the serialized RDS format.

We will also need to load a few packages for this lab:

  - `readxl` for importing Excel data
  - `dplyr` for wrangling data
  -  `Matrix` for handling sparse matrices
  - `igraph` for modelling and visualizing our network
  - `statnet` for additional inferential analysis tools

```{r load, message = FALSE}
library(readxl)
library(dplyr)
library(Matrix)
library(igraph)
library(statnet)
```

```{r data-import}
# Import existing graph objects
mention_graph <- readRDS("../data/mention_graph.RDS")
htag_graph <- readRDS("../data/htag_graph.RDS")

# Import original dataset
lab <- read_excel("../data/lab.xlsx") %>% 
  rename_all(~str_replace_all(., "\\s+", "")) # Remove whitespace from variable names
```

```{r graph-gen}
# graph_gen(df, col) - Generate a sociomatrix based on a generic shared 
# attribute

graph_gen <- function (df, col) {
  
  # Create an affiliation matrix connecting users based on a shared attribute
  user_attr_matrix <- df %>%
    select(user = Author, attr = !! sym(col)) %>%
    table() %>%
    unclass() %>%
    Matrix()
  
  # Multiply the affiliation matrix by its transpose to create a sociomatrix
  shared_attr_matrix <- user_attr_matrix %*% t(user_attr_matrix)
  
  return(shared_attr_matrix)
}


# graph_gen_region(df) - Generate a sociomatrix based on shared region - alias
# for graph_gen()
graph_gen_region <- function (df) {
  return(graph_gen(df, col = "Region"))
}

# graph_gen_acctype(df) - Generate a sociomatrix based on shared account type -
# alias for graph_gen()
graph_gen_acctype <- function (df) { 
  return(graph_gen(df, col = "AccountType"))
}

# graph_gen_gender(df) - Generate a sociomatrix based on shared gender - alias
# for graph_gen()
graph_gen_gender <- function (df) {
  return(graph_gen(df, col = "Gender"))
}


# graph_gen_verified(df) - Generate a sociomatrix based on shared verified
# status - alias for graph_gen()
graph_gen_verified <- function (df) {
  return(graph_gen(df, col = "TwitterVerified"))
}
```

```{r graph-gen-parsed}
# graph_gen_htag(df) - Generate a sociomatrix based on shared hashtag usage 
graph_gen_htag <- function (df) {
  
  # Combine hashtag lists from multiple tweets by the same user
  htag_uses <- df %>%
    select(user = Author, htags = Hashtags) %>%
    group_by(user) %>% mutate(htags = paste(htags, collapse = ", "),
                              htags = str_split(htags, ", ")) %>%
    rowwise() %>% mutate(htags = list(unique(htags)),
                         htags = list(sort(htags))) %>%
    distinct()
  
  # Convert the nested list to a matrix
  htag_uses_matrix <- htag_uses %>%
    unnest(htags) %>%
    table() %>%
    unclass() %>% 
    Matrix()
  
  # Multiply the affiliation matrix by its transpose to convert to a sociomatrix
  shared_htag_matrix <- htag_uses_matrix %*% t(htag_uses_matrix)
  
  return(shared_htag_matrix)
}

# Generate a sociomatrix based on shared interests
graph_gen_interests <- function (df) {
  
  # Combine hashtag lists from multiple tweets by the same user
  user_interests <- df %>%
    select(user = Author, interests = Interest) %>%
    group_by(user) %>% mutate(interests = paste(interests, collapse = ", "),
                              interests = str_split(interests, ", ")) %>%
    rowwise() %>% mutate(interests = list(unique(interests)),
                         interests = list(sort(interests))) %>%
    distinct()
  
  # Convert the nested list to a matrix
  user_interests_matrix <- user_interests %>%
    unnest(interests) %>%
    table() %>% 
    unclass() %>% 
    Matrix()
  
  # Multiply the affiliation matrix by its transpose to convert to a sociomatrix
  shared_interests_matrix <- user_interests_matrix %*% t(user_interests_matrix)
  
  return(shared_interests_matrix)
}


```